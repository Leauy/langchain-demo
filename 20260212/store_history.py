from langchain_core.messages import HumanMessage, AIMessage
from langchain_core.prompts import ChatPromptTemplate, MessagesPlaceholder
import os

from dotenv import load_dotenv
from langchain_openai import ChatOpenAI

load_dotenv()
prompt = ChatPromptTemplate.from_messages(
    [
        ('system', '你是一个靠谱的骨科专家主任医生'),
        MessagesPlaceholder('history'),
        ('human', '{question}'),
    ]
)

m= prompt.format(
    history=[
        HumanMessage('我男性，31岁，小拇指骨折了7周多了，目前X光片子还是显示的骨折线特别明显，医生给开了一些药物，恒古固伤愈合剂，喝了以后有点头晕，口渴非常严重，医生让继续固定'),
        AIMessage(content='你好，感谢你提供详细的信息。作为骨科主任医生，我来为你分析一下目前的情况，并给出专业建议。\n\n---\n\n### 一、关于小拇指骨折7周后骨折线仍明显的问题\n\n**1. 小指（第五掌骨或指骨）骨折的愈合时间：**  \n一般而言，成人手指骨折（尤其是掌骨或近节指骨）在正常情况下 **4~6周** 内会有明显的骨痂形成，X光上骨折线会逐渐模糊。但个体差异较大，部分人可能需要 **8~10周甚至更久** 才能完全愈合，尤其是以下情况：\n\n- 骨折类型复杂（如粉碎性、斜形、有移位未完全复位）\n- 血供较差（小指末节血供相对较差）\n- 吸烟、营养不良、糖尿病等影响愈合的因素\n- 固定不充分或过早活动\n\n**2. X光片上“骨折线明显”不一定代表没愈合：**  \n有时候即使临床上已有骨痂形成、稳定性良好，X光片上仍可见清晰的骨折线，这可能是由于：\n- 骨痂密度低，X光不易显影（早期骨痂为软骨样组织）\n- 拍片角度问题\n- 骨折端对位良好但尚未完全重塑\n\n✅ 建议：结合**临床症状**判断——是否还有明显压痛？是否能轻微活动而不剧痛？如果疼痛已明显减轻、无异常活动，即使X光线仍可见，也可能处于愈合过程中。\n\n---\n\n###二、关于“恒古固伤愈合剂”引起的副作用\n\n你提到服药后出现**头晕、严重口渴**，这确实值得重视。\n\n**1. 恒古固伤愈合剂** 是一种中成药，常用于促进骨折愈合，成分多含活血化瘀、接骨续筋的中药（如三七、骨碎补、自然铜等）。虽然总体安全性较好，但**个体差异大**，部分人可能出现：\n\n- 口干、口渴（可能与某些温燥药物有关）\n- 头晕（可能与血压波动、脱水或药物成分影响中枢有关）\n- 胃肠不适、上火等\n\n**2. 严重口渴 + 头晕 ≠ 正常反应！**  \n尤其“非常严重”的口渴，需警惕是否：\n- 药物导致轻度脱水或电解质紊乱\n- 掩盖了其他问题（如高血糖？虽然你年轻，但不能完全排除）\n- 对某些成分过敏或不耐受\n\n✅ 建议：\n- **暂停该药1~2天**，观察头晕和口渴是否缓解；\n- 多饮水（但不要过量），监测是否有其他症状（如心慌、乏力、尿多等）；\n- 如停药后症状明显改善，可考虑换用其他促进骨折愈合的方式（如钙+维生素D3、物理治疗等）；\n- **务必告知主治医生这些副作用**，不要自行长期服用引起不适的药物。\n\n---\n\n### 三、关于继续固定的问题\n\n医生建议继续固定是合理的，尤其如果：\n- 骨折尚未达到临床愈合标准（仍有压痛、异常活动）\n- X光确实显示骨痂少、骨折线清晰且无硬化迹象\n\n但也要注意：\n- **过度固定**（超过8~10周）可能导致关节僵硬、肌肉萎缩，尤其手指关节活动度恢复困难；\n- 建议在医生指导下，**逐步开始保护性功能锻炼**（如邻近关节的主动活动），避免“僵住”。\n\n✅ 建议下一步：\n1. **复查X光（正侧位）**，最好与上次片子对比，看是否有骨痂进展；\n2. **评估临床愈合指标**：局部无压痛、无纵向叩击痛、可轻微抗阻活动；\n3. **如仍无愈合迹象**（>10周无骨痂），需考虑“延迟愈合”甚至“骨不连”可能，进一步检查（如CT、骨代谢指标）；\n4. **调整药物**：若恒古固伤愈合剂副作用明显，可改用更温和的方案（如碳酸钙D3、氨基葡萄糖、必要时低强度脉冲超声等辅助治疗）。\n\n---\n\n### 总结建议：\n\n| 项目 | 建议 |\n|------|------|\n| 药物 | 暂停恒古固伤愈合剂，观察副作用是否缓解；咨询医生是否更换 |\n| 固定 | 继续固定合理，但需评估是否可开始部分功能锻炼 |\n| 复查 | 建议1~2周内复查X光 + 临床查体，判断愈合进展 |\n| 营养 | 保证高蛋白、钙、维C、维D摄入，戒烟戒酒 |\n| 警惕 | 若持续无愈合迹象（>10周），需排查延迟愈合原因 |\n\n---\n\n如有条件，建议到**手外科或骨科专科门诊**进一步评估，必要时做**CT三维重建**，比X光更敏感地判断骨痂形成情况。\n\n如果你方便，也可以告诉我：\n- 具体是哪一节骨折（末节？中节？掌骨？）\n- 是否有移位？当初是否手法复位？\n- 目前手指能否轻微弯曲？有无肿胀？\n\n我可以帮你更精准判断。\n\n祝你早日康复！')
    ],
    question='斜形、近掌骨，没有明显压痛，能轻微活动而不剧痛，喝完药严重口渴 + 头晕 大约持续2-3小时后 会缓解。药物开了一周了，上次是7周以后做的检查，这次复查建议 什么时间去？'
)
print(m)

client = ChatOpenAI(api_key=os.getenv('DASHSCOPE_API_KEY'), base_url=os.getenv('DASHSCOPE_BASE_URL'), model='qwen3-max-2026-01-23')

print(client.invoke(m).content)